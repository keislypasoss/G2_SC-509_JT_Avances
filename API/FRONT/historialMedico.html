<!-- historialMedico.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Gestión de Historial Médico</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body>

<!-- Menú -->
<div id="menu-container"></div>
<script>
  fetch('menu.html')
    .then(res => res.text())
    .then(html => {
      document.getElementById('menu-container').innerHTML = html;
    });
</script>

<!-- Formulario -->
<div class="container my-5">
  <h1 class="mb-4">Gestión de Historial Médico</h1>

  <form id="formHistorial">
    <div class="row g-3">
      <div class="col-md-2"><label>ID</label><input type="number" id="id" class="form-control" /></div>
      <div class="col-md-4">
      <label for="residente">Residente</label><select id="residente" class="form-control"></select></div>
       <div class="col-md-6"><label>Diagnósticos (separados por coma)</label><input type="text" id="diagnosticos" class="form-control" /></div>
      <div class="col-md-6">
      <label>Tratamientos Anteriores</label>
      <select id="tratamientos" class="form-control" multiple></select>
      </div>
      <div class="col-md-6"><label>Notas Médicas</label><input type="text" id="notas" class="form-control" /></div>
      <div class="col-md-3"><label>Fecha Actualización</label><input type="date" id="fecha" class="form-control" /></div>
    </div>

    <div class="mt-4 text-center">
      <button type="button" id="guardar" class="btn btn-primary">Guardar</button>
      <button type="button" id="actualizar" class="btn btn-success" style="display:none;">Actualizar</button>
      <button type="button" onclick="limpiar()" class="btn btn-danger">Limpiar</button>
    </div>
  </form>

  <!-- Tabla -->
  <div class="table-responsive mt-5">
    <table class="table table-striped table-bordered">
      <thead class="table-dark">
        <tr>
          <th>ID</th><th>Residente</th><th>Diagnósticos</th><th>Fecha Actualización</th><th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tbodyHistorial"></tbody>
    </table>
  </div>
</div>

<!-- Lógica con jQuery -->
<script>
  const URL = 'http://localhost:3000/api/historiales_medicos/';

  function limpiar() {
    $('#formHistorial')[0].reset();
    $('#guardar').show(); $('#actualizar').hide();
  }

  function cargar() {
    $.get(URL, data => {
      $('#tbodyHistorial').empty();
      data.forEach(h => {
        $('#tbodyHistorial').append(`
          <tr>
            <td>${h.id}</td>
            <td>${h.residente?.nombre || h.residente}</td>
            <td>${h.diagnosticos ? h.diagnosticos.join(', ') : ''}</td>
            <td>${h.fecha_actualizacion ? h.fecha_actualizacion.split('T')[0] : ''}</td>
            <td>
              <button class="btn btn-sm btn-primary" onclick="editar(${h.id})">Editar</button>
              <button class="btn btn-sm btn-danger" onclick="eliminar(${h.id})">Eliminar</button>
            </td>
          </tr>
        `);
      });
    });
  }

  $('#guardar').click(() => {
    const obj = {
      id: $('#id').val(),
      residente: $('#residente').val(),
      diagnosticos: $('#diagnosticos').val().split(',').map(d => d.trim()).filter(d => d),
      tratamientos_anteriores: $('#tratamientos').val(), 
      notas_medicas: $('#notas').val(),
      fecha_actualizacion: $('#fecha').val()
    };

    $.ajax({
      url: URL,
      type: 'POST',
      contentType: 'application/json',
      data: JSON.stringify(obj),
      success: () => { alert('Guardado con éxito'); limpiar(); cargar(); },
      error: e => alert('Error: ' + e.statusText)
    });
  });

  window.editar = id => {
  $.get(URL + id, h => {
    $('#id').val(h.id);
    $('#residente').val(h.residente);
    $('#diagnosticos').val(h.diagnosticos ? h.diagnosticos.join(', ') : '');

    if (h.tratamientos_anteriores && Array.isArray(h.tratamientos_anteriores)) {
      // Puede que tratamientos_anteriores sea array de objetos o IDs
      const ids = h.tratamientos_anteriores.map(t => typeof t === 'object' ? t._id : t);
      $('#tratamientos').val(ids);
    } else {
      $('#tratamientos').val([]);
    }

    $('#notas').val(h.notas_medicas);
    $('#fecha').val(h.fecha_actualizacion ? h.fecha_actualizacion.split('T')[0] : '');
    $('#guardar').hide(); 
    $('#actualizar').show();
  });
};


  $('#actualizar').click(() => {
    const obj = {
      id: $('#id').val(),
      residente: $('#residente').val(),
      diagnosticos: $('#diagnosticos').val().split(',').map(d => d.trim()).filter(d => d),
      tratamientos_anteriores: $('#tratamientos').val(), 
      notas_medicas: $('#notas').val(),
      fecha_actualizacion: $('#fecha').val()
    };

    $.ajax({
      url: URL + obj.id,
      type: 'PUT',
      contentType: 'application/json',
      data: JSON.stringify(obj),
      success: () => { alert('Actualizado con éxito'); limpiar(); cargar(); },
      error: e => alert('Error: ' + e.statusText)
    });
  });

  window.eliminar = id => {
    if (confirm('¿Eliminar historial con ID ' + id + '?')) {
      $.ajax({
        url: URL + id,
        type: 'DELETE',
        success: () => cargar(),
        error: e => alert('Error: ' + e.statusText)
      });
    }
  };
  function cargarOpcionesResidente() {
  $.get('/api/residentes', data => {
    const select = $('#residente');
    select.empty();
    select.append('<option value="">Seleccione un residente</option>');
    data.forEach(r => {
      select.append(`<option value="${r._id}">${r.nombre}</option>`);
    });
  });
}
function cargarOpcionesTratamientos() {
  $.get('/api/tratamientos', data => {
    const select = $('#tratamientos');
    select.empty();
    data.forEach(t => {
      const nombre = t.medicamento?.nombre || t._id;
      select.append(`<option value="${t._id}">${nombre}</option>`);
    });
  });
}



  $(document).ready(function () {
  cargar();
  cargarOpcionesResidente();
  cargarOpcionesTratamientos();
});


</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
