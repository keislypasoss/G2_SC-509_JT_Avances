<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Gestión de Visitas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body>
  <!-- Menú cargado dinámicamente -->
  <div id="menu-container"></div>
  <script>
    fetch('menu.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('menu-container').innerHTML = html;
      });
  </script>

  <div class="container my-5">
    <h1 class="mb-4">Gestión de Visitas</h1>

    <form id="formVisita">
      <div class="row g-3">
        <div class="col-md-2">
          <label>ID</label>
          <input type="number" id="id" class="form-control" />
        </div>
        <div class="col-md-4">
          <label>Nombre Visitante</label>
          <input type="text" id="nombre_visitante" class="form-control" />
        </div>
        <div class="col-md-4">
          <label>Residente (ID)</label>
          <input type="text" id="residente" class="form-control" placeholder="ID del Residente" />
        </div>
        <div class="col-md-3">
          <label>Fecha</label>
          <input type="date" id="fecha" class="form-control" />
        </div>
        <div class="col-md-3">
          <label>Hora</label>
          <input type="time" id="hora" class="form-control" />
        </div>
      </div>

      <div class="row g-3 mt-2">
        <div class="col-md-12">
          <label>Observaciones</label>
          <textarea id="observaciones" class="form-control" rows="2" placeholder="Comentarios u observaciones"></textarea>
        </div>
      </div>

      <div class="mt-4 text-center">
        <button type="button" id="guardar" class="btn btn-primary">Guardar</button>
        <button type="button" id="actualizar" class="btn btn-success" style="display:none;">Actualizar</button>
        <button type="button" onclick="limpiar()" class="btn btn-danger">Limpiar</button>
      </div>
    </form>

    <div class="table-responsive mt-5">
      <table class="table table-striped table-bordered">
        <thead class="table-dark">
          <tr>
            <th>ID</th>
            <th>Nombre Visitante</th>
            <th>Residente (ID)</th>
            <th>Fecha</th>
            <th>Hora</th>
            <th>Observaciones</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tbodyVisita"></tbody>
      </table>
    </div>
  </div>

  <script>
    const URL = 'http://localhost:3000/api/visita/';

    function limpiar() {
      $('#formVisita')[0].reset();
      $('#guardar').show();
      $('#actualizar').hide();
    }

    function cargar() {
      $.get(URL, data => {
        $('#tbodyVisita').empty();
        data.forEach(v => {
          const fechaStr = v.fecha ? new Date(v.fecha).toLocaleDateString() : '';
          $('#tbodyVisita').append(`
            <tr>
              <td>${v.id}</td>
              <td>${v.nombre_visitante}</td>
              <td>${(v.residente && (v.residente._id || v.residente)) || ''}</td>
              <td>${fechaStr}</td>
              <td>${v.hora || ''}</td>
              <td>${v.observaciones || ''}</td>
              <td>
                <button class="btn btn-sm btn-primary" onclick="editar(${v.id})">Editar</button>
                <button class="btn btn-sm btn-danger" onclick="eliminar(${v.id})">Eliminar</button>
              </td>
            </tr>
          `);
        });
      });
    }

    $('#guardar').click(() => {
      const obj = {
        id: Number($('#id').val()),
        nombre_visitante: $('#nombre_visitante').val(),
        residente: $('#residente').val().trim(),
        fecha: $('#fecha').val(),
        hora: $('#hora').val(),
        observaciones: $('#observaciones').val()
      };

      $.ajax({
        url: URL,
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(obj),
        success: () => { alert('Guardado!'); limpiar(); cargar(); },
        error: e => alert('Error: ' + e.statusText)
      });
    });

    window.editar = id => {
      $.get(URL + id, v => {
        $('#id').val(v.id);
        $('#nombre_visitante').val(v.nombre_visitante);
        $('#residente').val(v.residente ? (v.residente._id || v.residente) : '');
        $('#fecha').val(v.fecha ? v.fecha.substr(0,10) : '');
        $('#hora').val(v.hora || '');
        $('#observaciones').val(v.observaciones || '');
        $('#guardar').hide();
        $('#actualizar').show();
      });
    };

    $('#actualizar').click(() => {
      const obj = {
        id: Number($('#id').val()),
        nombre_visitante: $('#nombre_visitante').val(),
        residente: $('#residente').val().trim(),
        fecha: $('#fecha').val(),
        hora: $('#hora').val(),
        observaciones: $('#observaciones').val()
      };

      $.ajax({
        url: URL + obj.id,
        type: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify(obj),
        success: () => { alert('Actualizado!'); limpiar(); cargar(); },
        error: e => alert('Error: ' + e.statusText)
      });
    });

    window.eliminar = id => {
      if(confirm('¿Eliminar visita con ID ' + id + '?')) {
        $.ajax({
          url: URL + id,
          type: 'DELETE',
          success: () => { cargar(); },
          error: e => alert('Error: ' + e.statusText)
        });
      }
    };

    $(document).ready(cargar);
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
