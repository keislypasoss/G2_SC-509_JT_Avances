<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Gestión de Voluntarios</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body>
  <div id="menu-container"></div>
  <script>
    fetch('menu.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('menu-container').innerHTML = html;
      });
  </script>

  <div class="container my-5">
    <h1 class="mb-4">Gestión de Voluntarios</h1>

    <form id="formVoluntario">
      <div class="row g-3">
        <div class="col-md-2">
          <label>ID</label>
          <input type="number" id="id" class="form-control" />
        </div>
        <div class="col-md-3">
          <label>Nombre</label>
          <input type="text" id="nombre" class="form-control" />
        </div>
        <div class="col-md-3">
          <label>Apellido</label>
          <input type="text" id="apellido" class="form-control" />
        </div>
        <div class="col-md-4">
          <label>Especialidad</label>
          <input type="text" id="especialidad" class="form-control" />
        </div>
      </div>

      <div class="row g-3 mt-2">
        <div class="col-md-3">
          <label>Disponibilidad</label>
          <input type="text" id="disponibilidad" class="form-control" placeholder="Ej: Lunes, Miércoles, Viernes" />
        </div>
       
        <div class="form-group">
        <label>Actividades Realizadas</label>
        <select class="form-control" id="actividades" multiple></select>
        </div>


        <div class="col-md-3">
          <label>Contacto (Teléfono)</label>
          <input type="number" id="contacto" class="form-control" />
        </div>
        <div class="col-md-3">
          <label>Estado</label>
          <select id="estado" class="form-select">
            <option value="">Seleccione</option>
            <option>Activo</option>
            <option>Inactivo</option>
            <option>En pausa</option>
          </select>
        </div>
      </div>

      <div class="mt-4 text-center">
        <button type="button" id="guardar" class="btn btn-primary">Guardar</button>
        <button type="button" id="actualizar" class="btn btn-success" style="display:none;">Actualizar</button>
        <button type="button" onclick="limpiar()" class="btn btn-danger">Limpiar</button>
      </div>
    </form>

    <div class="table-responsive mt-5">
      <table class="table table-striped table-bordered">
        <thead class="table-dark">
          <tr>
            <th>ID</th><th>Nombre</th><th>Apellido</th><th>Especialidad</th><th>Disponibilidad</th><th>Actividades Realizadas</th><th>Contacto</th><th>Estado</th><th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tbodyVoluntarios"></tbody>
      </table>
    </div>
  </div>

  <!-- Lógica con jQuery -->
<script>
  const URL = 'http://localhost:3000/api/voluntarios/';

  function limpiar() {
    $('#formVoluntario')[0].reset();
    $('#guardar').show();
    $('#actualizar').hide();
  }

  function cargar() {
  $.get(URL, data => {
    $('#tbodyVoluntarios').empty();
    data.forEach(v => {
      const actividades = Array.isArray(v.actividades_realizadas)
        ? v.actividades_realizadas.map(a => a.nombre || a).join(', ')
        : '';
      $('#tbodyVoluntarios').append(`
        <tr>
          <td>${v.id}</td>
          <td>${v.nombre}</td>
          <td>${v.apellido}</td>
          <td>${v.especialidad}</td>
          <td>${v.disponibilidad}</td>
          <td>${actividades}</td>
          <td>${v.contacto}</td>
          <td>${v.estado}</td>
          <td>
            <button class="btn btn-sm btn-primary" onclick="editar(${v.id})">Editar</button>
            <button class="btn btn-sm btn-danger" onclick="eliminar(${v.id})">Eliminar</button>
          </td>
        </tr>
      `);
    });
  });
}


  $('#guardar').click(() => {
  const obj = {
    id: $('#id').val(),
    nombre: $('#nombre').val(),
    apellido: $('#apellido').val(),
    especialidad: $('#especialidad').val(),
    disponibilidad: $('#disponibilidad').val(),
    contacto: $('#contacto').val(),
    estado: $('#estado').val(),
    actividades_realizadas: $('#actividades').val() // IDs de actividades seleccionadas
  };

  $.ajax({
    url: URL,
    type: 'POST',
    contentType: 'application/json',
    data: JSON.stringify(obj),
    success: () => { alert('Guardado con éxito'); limpiar(); cargar(); },
    error: e => alert('Error: ' + e.statusText)
  });
});

window.editar = id => {
  $.get(URL + id, v => {
    $('#id').val(v.id);
    $('#nombre').val(v.nombre);
    $('#apellido').val(v.apellido);
    $('#especialidad').val(v.especialidad);
    $('#disponibilidad').val(v.disponibilidad);
    $('#contacto').val(v.contacto);
    $('#estado').val(v.estado);

    const actividades = Array.isArray(v.actividades_realizadas)
      ? v.actividades_realizadas.map(a => typeof a === 'object' ? a._id : a)
      : [];
    $('#actividades').val(actividades);

    $('#guardar').hide();
    $('#actualizar').show();
  });
};

$('#actualizar').click(() => {
  const obj = {
    id: $('#id').val(),
    nombre: $('#nombre').val(),
    apellido: $('#apellido').val(),
    especialidad: $('#especialidad').val(),
    disponibilidad: $('#disponibilidad').val(),
    contacto: $('#contacto').val(),
    estado: $('#estado').val(),
    actividades_realizadas: $('#actividades').val()
  };

  $.ajax({
    url: URL + obj.id,
    type: 'PUT',
    contentType: 'application/json',
    data: JSON.stringify(obj),
    success: () => { alert('Actualizado con éxito'); limpiar(); cargar(); },
    error: e => alert('Error: ' + e.statusText)
  });
});


  window.eliminar = id => {
    if (confirm('¿Eliminar voluntario con ID ' + id + '?')) {
      $.ajax({
        url: URL + id,
        type: 'DELETE',
        success: () => cargar(),
        error: e => alert('Error: ' + e.statusText)
      });
    }
  };

  function cargarOpcionesActividades() {
    $.get('/api/actividades', data => {
      const select = $('#actividades');
      select.empty();
      data.forEach(a => {
        select.append(`<option value="${a._id}">${a.nombre}</option>`);
      });
    });
  }

  $(document).ready(function () {
    cargar();
    cargarOpcionesActividades();
  });
</script>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
