<!-- actividad.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Gestión de Actividades</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body>

<!-- Menú -->
<div id="menu-container"></div>
<script>
  fetch('menu.html')
    .then(res => res.text())
    .then(html => {
      document.getElementById('menu-container').innerHTML = html;
    });
</script>

<!-- Formulario -->
<div class="container my-5">
  <h1 class="mb-4">Gestión de Actividades</h1>

  <form id="formActividad">
    <div class="row g-3">
      <div class="col-md-2"><label>ID</label><input type="number" id="id" class="form-control" /></div>
      <div class="col-md-4"><label>Nombre</label><input type="text" id="nombre" class="form-control" /></div>
      <div class="col-md-6"><label>Descripción</label><input type="text" id="descripcion" class="form-control" /></div>
      <div class="col-md-3"><label>Fecha</label><input type="date" id="fecha" class="form-control" /></div>
      <div class="col-md-4"><label>Lugar</label><input type="text" id="lugar" class="form-control" /></div>
      <div class="col-md-5"><label>Residentes (IDs separados por coma)</label><input type="text" id="residentes" class="form-control" /></div>
      <div class="col-md-5"><label>Personal (IDs separados por coma)</label><input type="text" id="personal" class="form-control" /></div>
      <div class="col-md-2">
        <label>Estado</label>
        <select id="estado" class="form-select">
          <option value="">Seleccione</option>
          <option>Programada</option>
          <option>En curso</option>
          <option>Finalizada</option>
          <option>Cancelada</option>
        </select>
      </div>
    </div>

    <div class="mt-4 text-center">
      <button type="button" id="guardar" class="btn btn-primary">Guardar</button>
      <button type="button" id="actualizar" class="btn btn-success" style="display:none;">Actualizar</button>
      <button type="button" onclick="limpiar()" class="btn btn-danger">Limpiar</button>
    </div>
  </form>

  <!-- Tabla -->
  <div class="table-responsive mt-5">
    <table class="table table-striped table-bordered">
      <thead class="table-dark">
        <tr>
          <th>ID</th><th>Nombre</th><th>Descripción</th><th>Fecha</th><th>Lugar</th><th>Estado</th><th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tbodyActividad"></tbody>
    </table>
  </div>
</div>

<!-- Lógica con jQuery -->
<script>
  const URL = 'http://localhost:3000/api/actividad/';

  function limpiar() {
    $('#formActividad')[0].reset();
    $('#guardar').show(); $('#actualizar').hide();
  }

  function cargar() {
    $.get(URL, data => {
      $('#tbodyActividad').empty();
      data.forEach(a => {
        $('#tbodyActividad').append(`
          <tr>
            <td>${a.id}</td><td>${a.nombre}</td><td>${a.descripcion}</td>
            <td>${a.fecha ? a.fecha.split('T')[0] : ''}</td>
            <td>${a.lugar}</td><td>${a.estado}</td>
            <td>
              <button class="btn btn-sm btn-primary" onclick="editar(${a.id})">Editar</button>
              <button class="btn btn-sm btn-danger" onclick="eliminar(${a.id})">Eliminar</button>
            </td>
          </tr>
        `);
      });
    });
  }

  $('#guardar').click(() => {
    const obj = {
      id: $('#id').val(),
      nombre: $('#nombre').val(),
      descripcion: $('#descripcion').val(),
      fecha: $('#fecha').val(),
      lugar: $('#lugar').val(),
      residentes: $('#residentes').val().split(',').map(r => r.trim()).filter(r => r),
      personal: $('#personal').val().split(',').map(p => p.trim()).filter(p => p),
      estado: $('#estado').val()
    };

    $.ajax({
      url: URL,
      type: 'POST',
      contentType: 'application/json',
      data: JSON.stringify(obj),
      success: () => { alert('Guardado con éxito'); limpiar(); cargar(); },
      error: e => alert('Error: ' + e.statusText)
    });
  });

  window.editar = id => {
    $.get(URL + id, a => {
      $('#id').val(a.id);
      $('#nombre').val(a.nombre);
      $('#descripcion').val(a.descripcion);
      $('#fecha').val(a.fecha ? a.fecha.split('T')[0] : '');
      $('#lugar').val(a.lugar);
      $('#residentes').val(a.residentes.join(', '));
      $('#personal').val(a.personal.join(', '));
      $('#estado').val(a.estado);
      $('#guardar').hide(); $('#actualizar').show();
    });
  };

  $('#actualizar').click(() => {
    const obj = {
      id: $('#id').val(),
      nombre: $('#nombre').val(),
      descripcion: $('#descripcion').val(),
      fecha: $('#fecha').val(),
      lugar: $('#lugar').val(),
      residentes: $('#residentes').val().split(',').map(r => r.trim()).filter(r => r),
      personal: $('#personal').val().split(',').map(p => p.trim()).filter(p => p),
      estado: $('#estado').val()
    };

    $.ajax({
      url: URL + obj.id,
      type: 'PUT',
      contentType: 'application/json',
      data: JSON.stringify(obj),
      success: () => { alert('Actualizado con éxito'); limpiar(); cargar(); },
      error: e => alert('Error: ' + e.statusText)
    });
  });

  window.eliminar = id => {
    if (confirm('¿Eliminar actividad con ID ' + id + '?')) {
      $.ajax({
        url: URL + id,
        type: 'DELETE',
        success: () => cargar(),
        error: e => alert('Error: ' + e.statusText)
      });
    }
  };

  $(document).ready(cargar);
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
