<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Gesti√≥n de Citas M√©dicas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body>
<!-- Dentro del body -->
<div id="menu-container"></div>

<script>
  fetch('menu.html')
    .then(res => res.text())
    .then(html => {
      document.getElementById('menu-container').innerHTML = html;
    });
</script>

<div class="container my-5">
  <h1 class="mb-4">Gesti√≥n de Citas M√©dicas</h1>

  <form id="formCita">
    <div class="row g-3">
      <div class="col-md-2"><label>ID</label><input type="number" id="id" class="form-control" /></div>
      <label for="residente">Residente:</label><select id="residente" name="residente" class="form-control"></select>
      <div class="col-md-3"><label>Fecha</label><input type="date" id="fecha" class="form-control" /></div>
      <div class="col-md-2"><label>Hora</label><input type="time" id="hora" class="form-control" /></div>
      <div class="col-md-4"><label>Motivo</label><input type="text" id="motivo" class="form-control" /></div>
      <label for="profesional">Profesional:</label><select id="profesional" name="profesional" class="form-control"></select>
      <div class="col-md-3">
        <label>Estado</label>
        <select id="estado" class="form-select">
          <option value="">Seleccione</option>
          <option>Pendiente</option>
          <option>Realizada</option>
          <option>Cancelada</option>
        </select>
      </div>
    </div>

    <div class="mt-4 text-center">
      <button type="button" id="guardar" class="btn btn-primary">Guardar</button>
      <button type="button" id="actualizar" class="btn btn-success" style="display:none;">Actualizar</button>
      <button type="button" onclick="limpiar()" class="btn btn-danger">Limpiar</button>
    </div>
  </form>

  <div class="table-responsive mt-5">
    <table class="table table-striped table-bordered">
      <thead class="table-dark">
        <tr>
          <th>ID</th><th>Residente</th><th>ID Profesional</th><th>Fecha</th><th>Hora</th><th>Motivo</th><th>Estado</th><th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tbodyCita"></tbody>
    </table>
  </div>
</div>

<script>
  const URL = 'http://localhost:3000/api/citas_medicas/';

  function limpiar() {
    $('#formCita')[0].reset();
    $('#guardar').show(); $('#actualizar').hide();
  }

  function cargar() {
  $.get(URL, data => {
    $('#tbodyCita').empty();
    console.log("Citas recibidas:", data); // üëà Aseg√∫rate de que llegan m√°s de 2
    data.forEach(c => {
      const residente = c.residente?.nombre || 'Sin residente';
      const profesional = c.profesional_salud?.nombre || 'Sin profesional';

      $('#tbodyCita').append(`
        <tr>
          <td>${c.id || c._id}</td>
          <td>${residente}</td>
          <td>${profesional}</td>
          <td>${c.fecha ? c.fecha.split('T')[0] : ''}</td>
          <td>${c.hora}</td>
          <td>${c.motivo}</td>
          <td>${c.estado}</td>
          <td>
            <button class="btn btn-sm btn-primary" onclick="editar('${c.id || c._id}')">Editar</button>
            <button class="btn btn-sm btn-danger" onclick="eliminar('${c.id || c._id}')">Eliminar</button>
          </td>
        </tr>
      `);
    });
  });
}

  $('#formularioFamiliar').submit(function (e) {
  e.preventDefault();

  const familiar = {
    id: $('#id').val(),
    nombre: $('#nombre').val(),
    parentesco: $('#parentesco').val(),
    telefono: $('#telefono').val(),
    residente: $('#residenteSelect').val(),
    personal: $('#personalSelect').val()
  };

  const metodo = familiar.id ? 'PUT' : 'POST';
  const urlFinal = familiar.id ? `${URL}/${familiar.id}` : URL;

  $.ajax({
    url: urlFinal,
    method: metodo,
    contentType: 'application/json',
    data: JSON.stringify(familiar),
    success: function () {
      cargar();
      $('#formularioFamiliar')[0].reset();
    }
  });
});
  $('#guardar').click(() => {
    const obj = {
      id: $('#id').val(),
      residente: $('#residente').val(),
      fecha: $('#fecha').val(),
      hora: $('#hora').val(),
      motivo: $('#motivo').val(),
      profesional_salud: $('#profesional').val(),
      estado: $('#estado').val()
    };

    $.ajax({
      url: URL,
      type: 'POST',
      contentType: 'application/json',
      data: JSON.stringify(obj),
      success: () => { 
        alert('Cita guardada!');
        limpiar();
        cargar();
      },
      error: e => alert('Error: ' + e.responseText)
    });
  });


  window.editar = id => {
  $.get(URL + id, c => {
    $('#id').val(c.id);
    $('#residente').val(c.residente._id || c.residente);
    $('#fecha').val(c.fecha ? c.fecha.split('T')[0] : '');
    $('#hora').val(c.hora);
    $('#motivo').val(c.motivo);
    $('#profesional').val(c.profesional_salud._id || c.profesional_salud);
    $('#estado').val(c.estado);
    $('#guardar').hide(); 
    $('#actualizar').show();
  });
};


  $('#actualizar').click(() => {
    const obj = {
      id: $('#id').val(),
      residente: $('#residente').val(),
      fecha: $('#fecha').val(),
      hora: $('#hora').val(),
      motivo: $('#motivo').val(),
      profesional_salud: $('#profesional').val(),
      estado: $('#estado').val()
    };

    $.ajax({
      url: URL + obj.id,
      type: 'PUT',
      contentType: 'application/json',
      data: JSON.stringify(obj),
      success: () => { alert('Actualizado!'); limpiar(); cargar(); },
      error: e => alert('Error: ' + e.statusText)
    });
  });

  window.eliminar = id => {
    if (confirm('¬øEliminar cita con ID ' + id + '?')) {
      $.ajax({
        url: URL + id,
        type: 'DELETE',
        success: () => { cargar(); },
        error: e => alert('Error: ' + e.statusText)
      });
    }
  };
  function cargarOpcionesProfesional() {
  $.get('/api/personal', data => {
    const select = $('#profesional');
    select.empty();
    data.forEach(p => {
      select.append(`<option value="${p._id}">${p.nombre}</option>`);
    });
  });
}

function cargarOpcionesResidente() {
  $.get('/api/residentes', data => { 
    const select = $('#residente');
    select.empty();
    data.forEach(r => {
      select.append(`<option value="${r._id}">${r.nombre}</option>`);
    });
  });
}


  $(document).ready(function() {
  cargarOpcionesProfesional();
  cargarOpcionesResidente();
  cargar(); 
});


</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
